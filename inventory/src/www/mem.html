<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Mémoire système</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; padding:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:canvas; color:canvastext; }
    .card { max-width:1000px; margin:0 auto 16px; padding:16px 20px; border:1px solid color-mix(in oklab, canvastext 15%, transparent); border-radius:16px; background:color-mix(in oklab, canvas 92%, canvastext 0%); box-shadow:0 1px 8px color-mix(in oklab, canvastext 10%, transparent); }
    h1 { margin:0 0 8px; font-size:1.25rem; }
    .muted { opacity:.75; font-size:.9rem; }
    .row { display:grid; grid-template-columns: 160px 1fr 110px; gap:12px; align-items:center; margin:12px 0; }
    .label { font-weight:600; }
    .val { text-align:right; font-variant-numeric: tabular-nums; }

    /* Progressbar */
    .bar { height:18px; width:100%; border-radius:12px; overflow:hidden;
           background: color-mix(in oklab, canvas 85%, canvastext 0%);
           outline: 1px solid color-mix(in oklab, canvastext 15%, transparent); position:relative; }
    .fill { height:100%; width:0%; transition:width .35s ease; }
    .fill.ram  { background: linear-gradient(90deg, #37b24d, #1e90ff); }
    .fill.swap { background: linear-gradient(90deg, #f59f00, #ff6b6b); }

    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px; }
    .kv { padding:10px 12px; border:1px solid color-mix(in oklab, canvastext 15%, transparent); border-radius:12px; background:color-mix(in oklab, canvas 96%, canvastext 0%); }
    .k { font-size:.85rem; opacity:.8; }
    .v { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { padding:6px 10px; border-radius:10px; border:1px solid color-mix(in oklab, dodgerblue 40%, transparent); background: color-mix(in oklab, dodgerblue 35%, canvas); color:white; cursor:pointer; }
    .btn[disabled]{ opacity:.6; cursor:default; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>

  <section class="card">
    <h1>Mémoire système</h1>
    <div class="muted">Source : <code>/mem</code> — rafraîchissement toutes les 5s</div>
    <div class="toolbar" style="margin-top:8px">
      <button id="refresh" class="btn" type="button">Rafraîchir</button>
      <span id="ts" class="muted"></span>
      <span id="status" class="muted"></span>
    </div>
  </section>

  <section class="card" aria-live="polite">
    <div class="row">
      <div class="label">RAM utilisée</div>
      <div class="bar"><div id="ramFill" class="fill ram"></div></div>
      <div class="val" id="ramPct">0.00%</div>
    </div>
    <div class="row">
      <div class="label">SWAP utilisée</div>
      <div class="bar"><div id="swapFill" class="fill swap"></div></div>
      <div class="val" id="swapPct">0.00%</div>
    </div>
  </section>

  <section class="card">
    <div class="grid" id="summary">
      <!-- Rempli dynamiquement -->
    </div>
  </section>

  <script>
    const MEM_URL = '/mem';
    const REFRESH_INTERVAL = 5000; // 5s
    let refreshing = false;

    function esc(s) {
      return String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function fmtBytes(n) {
      n = Number(n)||0;
      const units = ['B','KiB','MiB','GiB','TiB','PiB'];
      let i = 0;
      while (n >= 1024 && i < units.length-1) { n /= 1024; i++; }
      const s = (n < 10 ? n.toFixed(2) : n < 100 ? n.toFixed(1) : n.toFixed(0));
      return s + ' ' + units[i];
    }
    function setBar(el, pct) {
      const p = Math.max(0, Math.min(100, Number(pct)||0));
      el.style.width = p.toFixed(2) + '%';
    }
    function kv(key, val) {
      return '<div class="kv"><div class="k">'+esc(key)+'</div><div class="v">'+esc(val)+'</div></div>';
    }

    async function loadMem() {
      if (refreshing) return; // évite l’empilement si l’API est lente
      refreshing = true;

      const ts = document.getElementById('ts');
      const status = document.getElementById('status');
      const ramFill = document.getElementById('ramFill');
      const swapFill = document.getElementById('swapFill');
      const ramPct = document.getElementById('ramPct');
      const swapPct = document.getElementById('swapPct');
      const summary = document.getElementById('summary');

      status.textContent = '⏳ mise à jour…';

      try {
        const res = await fetch(MEM_URL, { headers: { 'Accept': 'application/json' } });
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const m = await res.json();
        const v = m.virtual || {};
        const s = m.swap || {};

        // RAM
        const ramUsedPct = Number(v.usedPercent) || 0;
        setBar(ramFill, ramUsedPct);
        ramPct.textContent = ramUsedPct.toFixed(2) + '%';

        // SWAP
        const swapUsedPct = Number(s.usedPercent) || 0;
        setBar(swapFill, swapUsedPct);
        swapPct.textContent = swapUsedPct.toFixed(2) + '%';

        // Résumé
        const items = [
          ['RAM totale', fmtBytes(v.total)],
          ['RAM utilisée', fmtBytes(v.used)],
          ['RAM libre', fmtBytes(v.free)],
          ['RAM disponible', fmtBytes(v.available)],
          ['Active', fmtBytes(v.active)],
          ['Inactive', fmtBytes(v.inactive)],
          ['Buffers', fmtBytes(v.buffers)],
          ['Cached', fmtBytes(v.cached)],
          ['Slab', fmtBytes(v.slab)],
          ['SReclaimable', fmtBytes(v.sreclaimable)],
          ['SUnreclaim', fmtBytes(v.sunreclaim)],
          ['Commit Limit', fmtBytes(v.commitLimit)],
          ['Committed AS', fmtBytes(v.committedAS)],
          ['Swap total', fmtBytes(s.total)],
          ['Swap utilisée', fmtBytes(s.used)],
          ['Swap libre', fmtBytes(s.free)],
          ['Page In', String(Number(s.pgIn)||0)],
          ['Page Out', String(Number(s.pgOut)||0)]
        ];

        summary.innerHTML = items.map(([k,val]) => kv(k, val)).join('');
        ts.textContent = 'Mis à jour : ' + new Date().toLocaleTimeString();
        status.textContent = '✅ OK';

      } catch (e) {
        summary.innerHTML = '<div class="kv"><div class="k">Erreur</div><div class="v">' + esc(e.message) + '</div></div>';
        status.textContent = '❌ ' + e.message;
      } finally {
        refreshing = false;
      }
    }

    // Bouton
    document.getElementById('refresh').addEventListener('click', async function(){
      const btn = this, prev = btn.textContent;
      btn.disabled = true; btn.textContent = '…';
      try { await loadMem(); }
      finally { btn.disabled = false; btn.textContent = prev; }
    });

    // Chargement immédiat + refresh 5s
    loadMem();
    setInterval(loadMem, REFRESH_INTERVAL);
  </script>

</body>
</html>
