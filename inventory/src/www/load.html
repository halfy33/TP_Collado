<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Charge système — Progressbars</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; padding:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:canvas; color:canvastext; }
    .card { max-width:880px; margin:0 auto 16px; padding:16px 20px; border:1px solid color-mix(in oklab, canvastext 15%, transparent); border-radius:16px; background:color-mix(in oklab, canvas 92%, canvastext 0%); box-shadow:0 1px 8px color-mix(in oklab, canvastext 10%, transparent); }
    h1, h2 { margin:0 0 8px; font-size:1.2rem; }
    .muted { opacity:.75; font-size:.9rem; }

    .row { display:grid; grid-template-columns: 140px 1fr 80px; gap:12px; align-items:center; margin:12px 0; }
    .label { font-weight:600; }

    /* Progressbar */
    .bar {
      height:18px; width:100%; border-radius:12px; overflow:hidden;
      background: color-mix(in oklab, canvas 85%, canvastext 0%);
      outline: 1px solid color-mix(in oklab, canvastext 15%, transparent);
      position: relative;
    }
    .fill {
      height:100%; width:0%;
      background: linear-gradient(90deg, #37b24d, #1e90ff);
      transition: width .35s ease;
    }
    /* Couleur selon charge (vert → orange → rouge) via data-level */
    .fill[data-level="low"]  { background: linear-gradient(90deg, #37b24d, #66d17a); }
    .fill[data-level="mid"]  { background: linear-gradient(90deg, #f59f00, #ffd43b); }
    .fill[data-level="high"] { background: linear-gradient(90deg, #e03131, #ff6b6b); }

    .val { text-align:right; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>

  <!-- LOAD AVERAGE -->
  <section class="card">
    <h1>Charge système (load average)</h1>
    <div class="muted">Source : <code>/avg</code> — jauges 0 → 4.0</div>
  </section>

  <section class="card" aria-live="polite">
    <div class="row">
      <div class="label">1 minute</div>
      <div class="bar"><div id="f1" class="fill" data-level="low"></div></div>
      <div class="val" id="v1">0.00</div>
    </div>
    <div class="row">
      <div class="label">5 minutes</div>
      <div class="bar"><div id="f5" class="fill" data-level="low"></div></div>
      <div class="val" id="v5">0.00</div>
    </div>
    <div class="row">
      <div class="label">15 minutes</div>
      <div class="bar"><div id="f15" class="fill" data-level="low"></div></div>
      <div class="val" id="v15">0.00</div>
    </div>
    <div class="muted" id="ts"></div>
  </section>

  <!-- CPU PER-CORE LOAD -->
  <section class="card">
    <h2>Charge CPU par cœur</h2>
    <div class="muted">Source : <code>/cpu</code> — <code>usage_percent</code> 0 → 100 (par cœur)</div>
  </section>

  <section class="card" aria-live="polite" id="cpuCard">
    <div id="cpuRows">
      <!-- lignes CPU insérées dynamiquement -->
    </div>
    <div class="muted" id="tsCpu"></div>
  </section>

  
  <script>
    // --- Helpers ---
    function pickBase(templateValue, fallback) {
      let b = (templateValue || '').trim();
      // Si le fichier est servi sans templating, la variable ressemblera à "{{.ServerURL}}"
      if (!b || b.includes('{{')) b = fallback;
      return b.replace(/\/+$/, '');
    }

    function level(v, max) {
      const r = max > 0 ? (v / max) : 0;
      if (r < 0.5) return "low";
      if (r < 0.8) return "mid";
      return "high";
    }

    // Bases / endpoints (avec fallback)
    const LOAD_BASE = pickBase("{{.LoadServerURL}}", "");
    const CPU_BASE  = pickBase("{{.CpuServerURL}}",  "");

    // --- LOAD AVERAGE ---
    const LOAD_SCALE_MAX = 4.0;

    async function loadAvg() {
      try {
        const res = await fetch(LOAD_BASE + "/avg", { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const d = await res.json(); // { avg: {load1,load5,load15}, misc: {...} }

        const avg = (d && d.avg) ? d.avg : {};
        const l1 = +avg.load1 || 0, l5 = +avg.load5 || 0, l15 = +avg.load15 || 0;

        const w1 = Math.max(0, Math.min(100, (l1 / LOAD_SCALE_MAX) * 100));
        const w5 = Math.max(0, Math.min(100, (l5 / LOAD_SCALE_MAX) * 100));
        const w15 = Math.max(0, Math.min(100, (l15 / LOAD_SCALE_MAX) * 100));

        const f1 = document.getElementById("f1");
        const f5 = document.getElementById("f5");
        const f15 = document.getElementById("f15");

        f1.style.width = w1 + "%";   f1.setAttribute("data-level", level(l1, LOAD_SCALE_MAX));
        f5.style.width = w5 + "%";   f5.setAttribute("data-level", level(l5, LOAD_SCALE_MAX));
        f15.style.width = w15 + "%"; f15.setAttribute("data-level", level(l15, LOAD_SCALE_MAX));

        document.getElementById("v1").textContent = l1.toFixed(2);
        document.getElementById("v5").textContent = l5.toFixed(2);
        document.getElementById("v15").textContent = l15.toFixed(2);
        document.getElementById("ts").textContent = "Mis à jour : " + new Date().toLocaleTimeString();
      } catch (e) {
        ["f1","f5","f15"].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.style.width = "0%";
          el.setAttribute("data-level", "low");
        });
        document.getElementById("ts").textContent = "Erreur /load : " + new Date().toLocaleTimeString();
      }
    }

    // --- CPU PER-CORE (usage %) ---
    const CPU_SCALE_MAX = 100.0; // usage_percent 0 → 100

    function ensureCpuBars(n) {
      const wrap = document.getElementById("cpuRows");
      if (wrap.dataset.count === String(n)) return;

      let html = "";
      for (let i = 0; i < n; i++) {
        html += '<div class="row">'
          + '<div class="label">CPU ' + i + '</div>'
          + '<div class="bar"><div id="fc-' + i + '" class="fill" data-level="low"></div></div>'
          + '<div class="val" id="vc-' + i + '">0.00%</div>'
          + "</div>";
      }
      wrap.innerHTML = html || '<div class="muted">Aucun cœur détecté</div>';
      wrap.dataset.count = String(n);
    }

    async function loadCpu() {
      try {
        const res = await fetch(CPU_BASE + "/cpu", { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const d = await res.json(); // { cores:[{usage_percent:... , info:{cpu:...}}] }

        const cores = (d && Array.isArray(d.cores)) ? d.cores : [];
        const n = cores.length;
        ensureCpuBars(n);

        for (let i = 0; i < n; i++) {
          const v = +cores[i].usage_percent || 0;
          const w = Math.max(0, Math.min(100, (v / CPU_SCALE_MAX) * 100));
          const f = document.getElementById("fc-" + i);
          const t = document.getElementById("vc-" + i);
          if (f) { f.style.width = w + "%"; f.setAttribute("data-level", level(v, CPU_SCALE_MAX)); }
          if (t) { t.textContent = v.toFixed(2) + "%"; }
        }
        document.getElementById("tsCpu").textContent = "Mis à jour : " + new Date().toLocaleTimeString();
      } catch (e) {
        const wrap = document.getElementById("cpuRows");
        const n = +(wrap.dataset.count || 0);
        for (let i = 0; i < n; i++) {
          const f = document.getElementById("fc-" + i);
          const t = document.getElementById("vc-" + i);
          if (f) { f.style.width = "0%"; f.setAttribute("data-level","low"); }
          if (t) { t.textContent = "0.00%"; }
        }
        document.getElementById("tsCpu").textContent = "Erreur /cpu : " + new Date().toLocaleTimeString();
      }
    }

    // Première charge + rafraîchissement
    loadAvg();
    loadCpu();
    setInterval(() => { loadAvg(); loadCpu(); }, 5000);
  </script>


</body>
</html>
